# ElinOS

**Language / 语言**: [English](README.md) | [简体中文](README_zh.md)

一个用 Rust 编写的最小操作系统，面向 RISC-V 64 位架构，具有动态内存管理、VirtIO 设备支持、简单文件系统和**生产级系统调用架构**，并提供适当的内核/用户空间分离。

## 🚀 特性

### 核心系统
- **RISC-V 64 位**目标架构
- 通过 OpenSBI 进行**动态内存检测**
- **自适应内存管理**，可配置堆和栈
- **串行 UART** 通信和调试
- **OpenSBI** 集成，提供平台服务
- **专业系统调用架构**，参考行业框架组织
- 通过 SBI 接口实现**系统关机/重启**

### 设备支持
- **VirtIO 块设备**驱动
- **自动设备探测**和初始化
- **QEMU virt 机器**支持
- **磁盘镜像管理**（qcow2 格式）

### 文件系统
- **内存文件系统**，支持文件操作
- **文件管理**命令（创建、读取、删除、列表）
- **块设备抽象**，为未来真实文件系统支持做准备
- **预加载测试文件**用于演示

### 系统调用架构
- 受 Qiling 框架启发的**分类组织**
- **基于范围的系统调用编号**，具有可扩展性
- **9 个不同类别**涵盖所有操作系统功能
- **专业结构**，为生产级开发做好准备
- 在类别边界内**易于扩展**

### 交互式 Shell
- 带历史记录和编辑功能的**命令行界面**
- **动态命令系统** - 添加新命令无需修改 main.rs
- 用于系统检查和文件管理的**内置命令**
- **集中命令处理**架构
- 带有全面文档的**帮助系统**

## 🛠 构建和运行

### 前置要求
- 带有 `riscv64gc-unknown-none-elf` 目标的 Rust 工具链
- 支持 RISC-V 的 QEMU (`qemu-system-riscv64`)
- 用于磁盘镜像格式化的 `mkfs.fat`（可选）

### 构建内核
```bash
./build.sh
```

### 使用 QEMU 运行
```bash
# 使用默认配置运行（128MB RAM，100MB 磁盘）
./run.sh

# 使用自定义内存大小运行
MEMORY=256M ./run.sh

# 使用自定义磁盘大小运行
DISK_SIZE=500M ./run.sh

# 使用自定义磁盘镜像运行
DISK_IMAGE=my_disk.qcow2 ./run.sh
```

## 💻 Shell 命令

ElinOS 启动后，您可以访问具有以下命令的交互式 shell：

### 系统信息
- `help` - 显示可用命令
- `memory` - 通过 SYS_GETMEMINFO 显示检测到的内存区域
- `devices` - 通过 SYS_GETDEVICES 探测和列出 VirtIO 设备
- `syscall` - 显示系统调用信息和架构
- `categories` - 显示系统调用分类系统
- `version` - 通过 SYS_ELINOS_VERSION 显示 ElinOS 版本

### 文件系统操作
- `ls` - 列出所有文件及大小（使用 SYS_GETDENTS）
- `cat <文件名>` - 显示文件内容（使用 SYS_OPEN）
- `touch <文件名>` - 创建新的空文件（使用文件系统 + SYS_OPEN）
- `rm <文件名>` - 删除文件（使用 SYS_UNLINK）

### 系统控制
- `shutdown` - 优雅关闭 ElinOS 并退出 QEMU（使用 SYS_ELINOS_SHUTDOWN）
- `reboot` - 重启系统（使用 SYS_ELINOS_REBOOT）
- `clear` - 清除屏幕（使用 SYS_WRITE）

### 示例会话
```
elinOS> help
可用命令：
  help       - 显示此帮助
  memory     - 显示内存信息
  devices    - 探测 VirtIO 设备
  ls         - 列出文件
  cat <file> - 显示文件内容
  touch <file> - 创建空文件
  rm <file>  - 删除文件
  clear      - 清除屏幕
  syscall    - 显示系统调用信息
  categories - 显示系统调用分类
  version    - 显示 ElinOS 版本
  shutdown   - 关闭系统
  reboot     - 重启系统

elinOS> categories
系统调用分类：
  1-50:   文件 I/O 操作
  51-70:  目录操作
  71-120: 内存管理
  121-170: 进程管理
  171-220: 设备和 I/O 管理
  221-270: 网络操作
  271-300: 时间和定时器操作
  301-350: 系统信息
  900-999: ElinOS 特定操作

elinOS> version
ElinOS v0.1.0 - RISC-V 操作系统
使用 Rust 构建，具有适当的系统调用架构
系统调用组织受 Qiling 框架启发

elinOS> shutdown
ElinOS 正在关闭...
再见！
# 自动返回到主机 shell
```

## 🏗 架构

### 系统调用架构
ElinOS 实现了具有行业标准组织的**生产级**操作系统架构：

#### 分类系统调用组织
受 **Qiling 框架**启发，系统调用被组织成具有专用编号范围的逻辑类别：

| 范围 | 类别 | 用途 | 示例 |
|------|------|------|------|
| 1-50 | 文件 I/O 操作 | 文件操作 | read, write, open, close, unlink |
| 51-70 | 目录操作 | 目录管理 | mkdir, rmdir, chdir, getcwd |
| 71-120 | 内存管理 | 内存操作 | mmap, munmap, mprotect, brk |
| 121-170 | 进程管理 | 进程控制 | exit, fork, execve, wait, kill |
| 171-220 | 设备和 I/O 管理 | 设备控制 | ioctl, fcntl, pipe, dup |
| 221-270 | 网络操作 | 网络栈 | socket, bind, listen, accept |
| 271-300 | 时间和定时器操作 | 时间管理 | gettimeofday, nanosleep |
| 301-350 | 系统信息 | 系统查询 | uname, sysinfo, getuid |
| 900-999 | ElinOS 特定操作 | 操作系统特定功能 | debug, version, shutdown |

#### 内核空间 (`src/syscall/`)
- **模块化组织**：每个类别在单独的文件中（file.rs, memory.rs 等）
- **中央调度器**：在 mod.rs 中基于范围的路由
- **类型安全接口**：用于错误处理的 SysCallResult 枚举
- **安全性**：输入验证和边界强制
- **可扩展性**：在类别内易于添加新系统调用

#### 用户空间 (`src/commands.rs`)
- **动态命令系统**：添加新命令无需修改 main.rs
- **集中处理**：具有自动调度的单一入口点
- **错误处理**：所有命令的一致错误报告
- **可扩展设计**：只需添加到命令列表并实现函数

#### Shell (`src/main.rs`)
- **简化设计**：将所有命令处理委托给命令模块
- **清洁架构**：shell 和命令实现之间的最小耦合
- **交互体验**：提供用户友好的界面

### 项目结构
```
src/
├── main.rs          # 内核入口点和 shell
├── syscall/         # 系统调用接口（内核空间）
│   ├── mod.rs       # 中央调度器和实用程序
│   ├── file.rs      # 文件 I/O 操作（1-50）
│   ├── directory.rs # 目录操作（51-70）
│   ├── memory.rs    # 内存管理（71-120）
│   ├── process.rs   # 进程管理（121-170）
│   ├── device.rs    # 设备和 I/O 管理（171-220）
│   ├── network.rs   # 网络操作（221-270）
│   ├── time.rs      # 时间和定时器操作（271-300）
│   ├── sysinfo.rs   # 系统信息（301-350）
│   └── elinos.rs    # ElinOS 特定操作（900-999）
├── commands.rs      # 具有动态调度的用户空间命令
├── memory.rs        # 动态内存管理
├── sbi.rs          # 带关机支持的 OpenSBI 接口
├── virtio_blk.rs   # VirtIO 块设备驱动
├── filesystem.rs   # 内存文件系统
└── linker.ld       # 具有灵活内存布局的链接器脚本
```

### 关键组件

#### 系统调用接口 (`src/syscall/`)
- **专业组织**：9 文件结构，每个类别自包含
- **行业标准**：遵循 Qiling 框架的验证方法
- **基于范围的编号**：在类别内可未来验证扩展
- **生产就绪**：跨 5 个类别实现了 10 个系统调用
- **开发者友好**：清晰所有权、隔离更改、易于测试

#### 动态命令系统 (`commands.rs`)
- **自注册**：命令在 shell 中自动可用
- **集中调度**：单一函数处理所有路由
- **错误处理**：一致的错误报告
- **易于扩展**：添加命令函数 + 更新帮助，就是这样！

#### 系统控制 (`sbi.rs`)
- **SBI 关机支持**：适当的 RISC-V 系统关机/重启
- **清洁退出**：优雅关机，返回到主机 shell
- **标准接口**：使用 SBI 系统重置扩展

## 🔧 配置

### 内存配置
系统自动检测可用内存，但您可以覆盖默认值：

```bash
# 设置 QEMU 内存大小
MEMORY=512M ./run.sh
```

### 磁盘配置
磁盘镜像会自动创建和格式化：

```bash
# 自定义磁盘大小
DISK_SIZE=1G ./run.sh

# 使用现有磁盘镜像
DISK_IMAGE=existing.qcow2 ./run.sh
```

## 🚧 未来增强

### 即时路线图
- [ ] **完善 SYS_READ** - 通过文件描述符完整文件读取
- [ ] **目录操作** - mkdir, rmdir, chdir 实现
- [ ] **内存映射** - 用于高级内存管理的 mmap/munmap
- [ ] **进程 Fork/Exec** - 基本多任务基础

### 中期
- [ ] **内存保护** - 带页表的用户/内核内存分离
- [ ] **真实 VirtIO I/O** - 带 DMA 的完整块设备实现
- [ ] **FAT32 支持** - 与 `fatfs` crate 集成用于真实文件系统
- [ ] **网络支持** - VirtIO 网络设备驱动

### 长期
- [ ] **多核支持** - 带适当同步的 SMP
- [ ] **高级调度** - 类似 CFS 的调度器实现
- [ ] **文本编辑器** - 简单文件编辑功能
- [ ] **进程间通信** - 管道和共享内存
- [ ] **安全框架** - 功能和沙箱

## 🐛 调试

### QEMU 日志
调试信息记录到 `qemu.log`：
```bash
tail -f qemu.log
```

### 内存问题
使用 `memory` 命令检查检测到的区域：
```bash
elinOS> memory
```

### 设备问题
检查 VirtIO 设备检测：
```bash
elinOS> devices
```

### 系统调用调试
检查系统调用接口：
```bash
elinOS> syscall
elinOS> categories
```

## 📚 技术细节

### 启动过程
1. **OpenSBI** 加载并初始化平台
2. **内核**在 `main.rs` 中的 `_start` 开始
3. 通过 OpenSBI 调用进行**内存检测**
4. **设备探测** VirtIO 设备
5. 带测试文件的**文件系统初始化**
6. **系统调用接口**激活
7. 用于用户交互的 **Shell 启动**

### 系统调用实现
- **分类组织**：行业标准结构，便于维护
- **基于范围的调度**：高效路由到类别处理器
- **类型安全接口**：用于错误处理的 SysCallResult 枚举
- **参数传递**：使用 RISC-V 调用约定
- **安全性**：输入验证和边界检查

### 动态命令架构
- **自包含**：命令模块处理所有调度逻辑
- **可扩展**：添加命令无需修改 main.rs
- **错误处理**：集中错误报告
- **可维护**：清晰的关注点分离

### 安全性和正确性
- 尽可能使用**安全 Rust**编写
- 用于硬件访问的最小 `unsafe` 块
- **系统调用边界**强制内核保护
- 基于自旋锁的同步
- 内核中无堆分配（使用栈和静态存储）

### 内核设计原则
- **生产架构**：可扩展、可维护的组织
- **行业标准**：遵循 Qiling 等经过验证的框架
- **类型安全**：利用 Rust 的类型系统保证正确性
- **模块化设计**：易于扩展和维护
- **清晰边界**：适当的内核/用户空间分离

## 📄 许可证

此项目是开源的。欢迎使用、修改和分发。

---

**ElinOS** - 一个最小操作系统，展示了 Rust 中的**生产级内核开发实践**，具有专业的系统调用架构和行业标准组织。 