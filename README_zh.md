# ElinOS

**Language / 语言**: [English](README.md) | [简体中文](README_zh.md)

基于 Rust 开发的 RISC-V 64位精简操作系统，实现了动态内存管理、VirtIO 设备支持、简易文件系统，以及**企业级系统调用架构**，具备完整的内核态/用户态隔离机制。

## 🚀 核心特性

### 系统内核
- **RISC-V 64位** 架构支持
- **动态内存探测** 基于 OpenSBI 实现
- **智能内存管理** 支持堆栈动态配置
- **串口调试** UART 通信支持
- **OpenSBI 集成** 提供底层平台服务
- **工业级系统调用** 参考业界主流框架设计
- **优雅关机重启** 通过 SBI 接口实现

### 硬件设备
- **VirtIO 块设备** 驱动程序
- **设备自动识别** 即插即用支持
- **QEMU 虚拟机** 完美适配
- **磁盘镜像** qcow2 格式管理

### 文件系统
- **内存文件系统** 支持基础文件操作
- **文件管理工具** 增删查改一应俱全
- **块设备抽象层** 为真实文件系统做准备
- **内置测试文件** 开箱即用演示

### 系统调用设计
- **分类管理架构** 参考 Qiling 框架设计理念
- **编号范围划分** 具备出色的可扩展性
- **九大功能模块** 覆盖操作系统全部功能
- **工程化结构** 满足生产环境开发需求
- **模块内扩展** 新增功能轻而易举

### 命令行界面
- **交互式终端** 支持历史记录和编辑
- **动态命令系统** 新增命令无需修改 main.rs
- **丰富内置工具** 系统监控和文件操作
- **集中化处理** 统一的命令分发架构
- **完善帮助系统** 详细的使用文档

## 🛠 编译运行

### 环境准备
- Rust 工具链（需包含 `riscv64gc-unknown-none-elf` 目标）
- QEMU RISC-V 模拟器 (`qemu-system-riscv64`)
- `mkfs.fat` 磁盘格式化工具（可选）

### 编译内核
```bash
./build.sh
```

### QEMU 启动
```bash
# 默认配置启动（128MB 内存，100MB 磁盘）
./run.sh

# 自定义内存大小
MEMORY=256M ./run.sh

# 自定义磁盘容量
DISK_SIZE=500M ./run.sh

# 使用指定磁盘镜像
DISK_IMAGE=my_disk.qcow2 ./run.sh
```

## 💻 内置命令

ElinOS 启动后提供完整的命令行环境：

### 系统监控
- `help` - 查看所有可用命令
- `memory` - 显示内存布局信息（SYS_GETMEMINFO）
- `devices` - 扫描 VirtIO 设备（SYS_GETDEVICES）
- `syscall` - 查看系统调用详情
- `categories` - 显示系统调用分类
- `version` - 查看系统版本（SYS_ELINOS_VERSION）

### 文件操作
- `ls` - 列出文件清单（SYS_GETDENTS）
- `cat <文件名>` - 查看文件内容（SYS_OPEN）
- `touch <文件名>` - 创建空文件（文件系统 + SYS_OPEN）
- `rm <文件名>` - 删除文件（SYS_UNLINK）

### 系统控制
- `shutdown` - 优雅关机并退出 QEMU（SYS_ELINOS_SHUTDOWN）
- `reboot` - 系统重启（SYS_ELINOS_REBOOT）
- `clear` - 清屏（SYS_WRITE）

### 使用演示
```
elinOS> help
可用命令列表：
  help       - 显示帮助信息
  memory     - 内存信息查看
  devices    - 设备扫描
  ls         - 文件列表
  cat <file> - 文件内容
  touch <file> - 创建文件
  rm <file>  - 删除文件
  clear      - 清屏
  syscall    - 系统调用信息
  categories - 调用分类
  version    - 系统版本
  shutdown   - 关机
  reboot     - 重启

elinOS> categories
系统调用分类：
  1-50:   文件 I/O 操作
  51-70:  目录操作
  71-120: 内存管理
  121-170: 进程管理
  171-220: 设备与 I/O 管理
  221-270: 网络操作
  271-300: 时间与定时器
  301-350: 系统信息
  900-999: ElinOS 专有功能

elinOS> version
ElinOS v0.1.0 - RISC-V 操作系统
基于 Rust 构建，采用先进的系统调用架构
系统调用组织借鉴 Qiling 框架设计

elinOS> shutdown
ElinOS 正在关机...
再见！
# 自动返回宿主机终端
```

## 🏗 技术架构

### 系统调用设计
ElinOS 采用**工业级**操作系统架构，符合业界标准：

#### 分类化系统调用组织
借鉴 **Qiling 框架** 设计思想，将系统调用按功能模块划分，每个模块分配独立编号范围：

| 编号范围 | 功能模块 | 应用场景 | 典型调用 |
|---------|----------|----------|----------|
| 1-50 | 文件 I/O | 文件读写操作 | read, write, open, close, unlink |
| 51-70 | 目录管理 | 目录树操作 | mkdir, rmdir, chdir, getcwd |
| 71-120 | 内存管理 | 内存分配回收 | mmap, munmap, mprotect, brk |
| 121-170 | 进程管理 | 进程生命周期 | exit, fork, execve, wait, kill |
| 171-220 | 设备 I/O | 设备控制 | ioctl, fcntl, pipe, dup |
| 221-270 | 网络通信 | 网络协议栈 | socket, bind, listen, accept |
| 271-300 | 时间管理 | 定时器操作 | gettimeofday, nanosleep |
| 301-350 | 系统信息 | 系统状态查询 | uname, sysinfo, getuid |
| 900-999 | ElinOS 专用 | 操作系统特有功能 | debug, version, shutdown |

#### 内核空间设计 (`src/syscall/`)
- **模块化架构**：各功能模块独立文件管理（file.rs, memory.rs 等）
- **中央调度器**：mod.rs 实现基于范围的智能路由
- **类型安全**：SysCallResult 枚举确保错误处理安全
- **权限控制**：输入校验和边界检查机制
- **扩展性强**：模块内新增系统调用极其便利

#### 用户空间设计 (`src/commands.rs`)
- **动态命令**：新增命令无需触动 main.rs
- **统一处理**：单一入口点自动分发机制
- **错误统一**：所有命令统一错误处理规范
- **开发友好**：仅需实现函数并更新帮助即可

#### 命令解释器 (`src/main.rs`)
- **极简设计**：所有命令处理统一委托
- **松耦合架构**：解释器与命令实现完全解耦
- **用户体验**：提供友好的交互界面

### 工程结构
```
src/
├── main.rs          # 内核入口与命令解释器
├── syscall/         # 系统调用接口（内核态）
│   ├── mod.rs       # 中央调度器与工具函数
│   ├── file.rs      # 文件 I/O（1-50）
│   ├── directory.rs # 目录操作（51-70）
│   ├── memory.rs    # 内存管理（71-120）
│   ├── process.rs   # 进程管理（121-170）
│   ├── device.rs    # 设备 I/O 管理（171-220）
│   ├── network.rs   # 网络操作（221-270）
│   ├── time.rs      # 时间定时器（271-300）
│   ├── sysinfo.rs   # 系统信息（301-350）
│   └── elinos.rs    # ElinOS 专用（900-999）
├── commands.rs      # 用户态命令（动态分发）
├── memory.rs        # 动态内存管理
├── sbi.rs          # OpenSBI 接口（含关机支持）
├── virtio_blk.rs   # VirtIO 块设备驱动
├── filesystem.rs   # 内存文件系统
└── linker.ld       # 链接脚本（灵活内存布局）
```

### 核心组件

#### 系统调用接口 (`src/syscall/`)
- **工程化组织**：9文件架构，各模块职责清晰
- **业界标准**：遵循 Qiling 等成熟框架实践
- **范围编号**：模块内扩展空间充足
- **生产就绪**：已实现 5大类 10+ 系统调用
- **开发友好**：权责明确，改动隔离，测试便利

#### 动态命令系统 (`commands.rs`)
- **自动注册**：命令在解释器中自动生效
- **集中分发**：单函数处理所有路由逻辑
- **错误统一**：一致的错误处理机制
- **扩展简单**：添加函数 + 更新帮助即可

#### 系统控制 (`sbi.rs`)
- **SBI 关机**：标准 RISC-V 系统关机重启
- **优雅退出**：关机后自动返回宿主机
- **标准接口**：使用 SBI 系统重置扩展

## 🔧 配置选项

### 内存配置
系统会自动探测可用内存，也可手动指定：

```bash
# 设置 QEMU 内存大小
MEMORY=512M ./run.sh
```

### 磁盘配置
磁盘镜像会自动创建和格式化：

```bash
# 自定义磁盘大小
DISK_SIZE=1G ./run.sh

# 使用现有镜像
DISK_IMAGE=existing.qcow2 ./run.sh
```

## 🚧 开发规划

### 近期目标
- [ ] **完善 SYS_READ** - 文件描述符完整读取
- [ ] **目录操作** - mkdir, rmdir, chdir 等实现
- [ ] **内存映射** - mmap/munmap 高级内存管理
- [ ] **进程创建** - fork/exec 多任务基础

### 中期规划
- [ ] **内存保护** - 页表机制用户/内核隔离
- [ ] **真实 VirtIO** - 完整 DMA 块设备实现
- [ ] **FAT32 文件系统** - 集成 `fatfs` 库支持
- [ ] **网络支持** - VirtIO 网卡驱动

### 长期愿景
- [ ] **多核支持** - SMP 对称多处理
- [ ] **智能调度** - CFS 类调度算法
- [ ] **文本编辑器** - 简易文件编辑功能
- [ ] **进程通信** - 管道与共享内存
- [ ] **安全框架** - 权限控制与沙箱

## 🐛 调试技巧

### QEMU 日志
调试信息记录在 `qemu.log`：
```bash
tail -f qemu.log
```

### 内存问题排查
使用 `memory` 命令检查内存布局：
```bash
elinOS> memory
```

### 设备问题排查
检查 VirtIO 设备识别情况：
```bash
elinOS> devices
```

### 系统调用调试
查看系统调用接口状态：
```bash
elinOS> syscall
elinOS> categories
```

## 📚 技术细节

### 启动流程
1. **OpenSBI** 平台初始化
2. **内核启动** 从 `main.rs` 的 `_start` 开始
3. **内存探测** 通过 OpenSBI 调用获取内存布局
4. **设备扫描** 自动识别 VirtIO 设备
5. **文件系统** 初始化并加载测试文件
6. **系统调用** 接口激活
7. **命令解释器** 启动用户交互

### 系统调用实现
- **分类架构**：业界标准结构便于维护
- **范围分发**：高效路由到各模块处理器
- **类型安全**：SysCallResult 确保错误处理
- **参数传递**：遵循 RISC-V 调用约定
- **安全检查**：输入校验与边界保护

### 动态命令架构
- **自包含设计**：命令模块独立处理分发逻辑
- **扩展性强**：新增命令无需修改 main.rs
- **错误统一**：集中化错误报告机制
- **维护友好**：清晰的职责分离

### 安全与可靠性
- **安全 Rust**：尽可能使用安全代码
- **最小 unsafe**：仅硬件访问使用不安全块
- **调用边界**：系统调用确保内核保护
- **自旋锁同步**：基于 spin 锁的并发控制
- **无堆分配**：内核使用栈和静态存储

### 内核设计理念
- **工程化架构**：可扩展可维护的组织结构
- **业界标准**：遵循 Qiling 等成熟框架
- **类型安全**：充分利用 Rust 类型系统
- **模块化设计**：便于扩展和维护
- **清晰边界**：严格的内核态/用户态分离

## 📄 开源协议

本项目采用开源协议，欢迎使用、修改和分发。

---

**ElinOS** - 一款展示 Rust **工业级内核开发实践**的精简操作系统，具备专业的系统调用架构和业界标准的工程组织。 