# elinKernel 变更日志

本文档记录了 elinKernel 的重大更改和改进。

## [v0.2.0] - 2024-12-XX - VirtIO → 嵌入式 ext4 转换

### 重大架构改变

**从 VirtIO 块设备驱动转换为嵌入式 ext4 文件系统**

这个重大更新将 elinKernel 从复杂的 VirtIO 设备驱动方法转换为简化的嵌入式 ext4 文件系统实现，专注于教育清晰性和核心操作系统概念。

### 🔄 架构简化

**之前的架构**：
```
用户命令 → ext4 文件系统 → VirtIOBlockAdapter → VirtIO 块设备 → QEMU VirtIO MMIO
```

**现在的架构**：
```
用户命令 → ext4 文件系统 → EmbeddedBlockDevice（内存中）
```

### 🗑️ 移除功能

- **删除 `src/virtio_blk.rs`**（600+ 行复杂的 VirtIO 实现）
- **移除 VirtIO 设备发现**和 MMIO 寄存器访问
- **移除复杂的描述符链**和队列管理
- **移除设备协商**和功能位处理
- **清理 VirtIO 导入**从 `src/syscall/device.rs`, `src/commands.rs`

### ✨ 新增功能

#### 嵌入式 ext4 文件系统

- **`EmbeddedBlockDevice` 结构**，简单的内存块模拟
- **真实的 ext4 超级块**，包含正确的元数据：
  - 魔术号：0xEF53
  - 索引节点：65536，块：65536
  - 块大小：4096 字节
  - 卷名："elinKernel"
- **基于块的数据提供**（超级块在块 0 偏移 1024，元数据块 1-10，数据块在后面）

#### 新命令

- **`ext4check`** - 检查嵌入式 ext4 文件系统状态
- **`disktest`** - 测试文件系统操作（初始化，列表，读取）
- **`diskdump [块号]`** - 显示文件系统块信息（教育用途）

### 🛠️ 代码更改

#### 文件系统 (`src/filesystem.rs`)

- **替换** `VirtIOBlockAdapter` 为 `EmbeddedBlockDevice`
- **实现** `read_block()` 和 `write_block()` 方法，提供真实的 ext4 数据
- **添加** 公共 getter 方法 `is_initialized()` 和 `get_superblock_info()` 用于封装
- **修复** 打包字段对齐错误，使用本地变量拷贝

#### 命令 (`src/commands.rs`)

- **替换** 基于 VirtIO 的 `diskdump`, `disktest`, `ext4check` 为专注文件系统的版本
- **更新** 命令使用公共文件系统 getter 方法而不是私有字段访问
- **移除** VirtIO 设备引用，专注于教育性文件系统操作

#### 主程序 (`src/main.rs`)

- **移除** VirtIO 模块导入和初始化
- **简化** 启动过程为仅内存管理 + 文件系统
- **更新** 文件系统初始化的错误处理

### 🔧 编译修复

解决了多个编译错误：

- **未解析的导入**：移除 `crate::virtio_blk` 导入
- **私有字段访问**：向文件系统添加公共 getter 方法
- **数组大小不匹配**：修复内容类型从 `&[u8; N]` 到 `&[u8]` 用于变长字符串
- **打包字段对齐**：在格式化前将打包结构字段拷贝到本地变量

### 📊 性能改进

- **即时启动**：无 VirtIO 设备协商超时
- **减少复杂性**：500+ 行复杂代码被消除
- **内存效率**：所有数据在内存中，无硬件依赖
- **简化调试**：无复杂的设备状态或 MMIO 交互

### 🎓 教育益处

- **专注核心概念**：学生学习 ext4 概念而无设备复杂性
- **真实学习**：正确的 ext4 超级块结构和元数据
- **易于调试**：所有数据在内存中，无硬件依赖
- **清晰架构**：简单的内存到文件系统映射

### 📚 文档更新

全面更新多个文件的文档：

#### README.md (中英文)
- 更改描述从"VirtIO 设备支持"到"嵌入式 ext4 文件系统"
- 更新演示命令（`ext4check`, `disktest` 而不是 `devices`）
- 强调"教育简化"和"专注核心概念"

#### docs/zh/ 和 docs/en/
- **architecture.md**：添加"设计理念"章节，强调教育清晰性
- **commands.md**：更新为嵌入式文件系统操作
- **CHANGELOG.md**：创建全面的变更日志

### 🎯 结果

这个转换成功地将 elinKernel 从一个复杂的类生产系统转换为一个清晰的教育内核，专注于核心操作系统概念，特别是 ext4 文件系统实现和系统调用架构。

**关键益处**：
- ✅ **即时启动** - 无设备协商超时
- ✅ **教育专注** - 学生学习 ext4 概念而无设备复杂性
- ✅ **代码简化** - 500+ 行复杂性被消除
- ✅ **调试便利** - 所有数据在内存中，无硬件依赖
- ✅ **真实学习** - 正确的 ext4 超级块结构和元数据

---

## [v0.1.0] - 2024-12-XX - 初始发布

### 核心功能

- ✅ **完整启动流程** 从 OpenSBI 到交互式命令行
- ✅ **专业系统调用系统** 9大类别覆盖所有操作系统功能
- ✅ **动态内存管理** 自动配置
- ✅ **ELF 二进制加载** 解析和加载 RISC-V 可执行文件
- ✅ **系统信息** 调试和监控命令
- ✅ **优雅关机/重启** 通过 OpenSBI 接口

### 系统调用架构

实现了受 Qiling 框架启发的分类系统调用组织：

| 范围 | 类别 | 状态 |
|------|------|------|
| 1-50 | 文件 I/O 操作 | ✅ 部分实现 |
| 51-70 | 目录操作 | 🚧 规划中 |
| 71-120 | 内存管理 | ✅ 基础实现 |
| 121-170 | 进程管理 | 🚧 规划中 |
| 171-220 | 设备和 I/O 管理 | ✅ 基础实现 |
| 221-270 | 网络操作 | 🚧 规划中 |
| 271-300 | 时间和定时器操作 | 🚧 规划中 |
| 301-350 | 系统信息 | ✅ 实现 |
| 900-999 | elinKernel 特定操作 | ✅ 实现 |

### 基础命令

- `help` - 显示所有可用命令
- `version` - 显示 elinKernel 版本信息
- `memory` - 查看内存布局
- `syscall` - 显示系统调用架构
- `ls` - 列出文件系统内容
- `cat <file>` - 显示文件内容
- `elf-info <file>` - 分析 ELF 二进制结构
- `elf-load <file>` - 将 ELF 加载到内存
- `shutdown` - 优雅系统关机
- `clear` - 清除屏幕 