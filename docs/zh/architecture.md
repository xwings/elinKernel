# elinOS 技术架构

本文档详细介绍 elinOS 的架构设计、技术原理和实现细节。

## 设计理念

elinOS 优先考虑**实验研究的清晰性**而非生产环境的复杂性：

- **VirtIO 块设备**：现代准虚拟化存储接口
- **FAT32 文件系统**：真实的文件系统实现，支持实际磁盘 I/O
- **Linux 兼容系统调用**：标准系统调用接口，便于学习
- **Rust 安全保障**：类型安全实现，防止常见操作系统错误
- **模块化设计**：清晰的关注点分离，便于理解

## 系统调用架构

elinOS 实现了**Linux 兼容**的系统调用架构，用于实验研究。

### 系统调用分类

| 分类 | 系统调用 | 说明 |
|------|----------|------|
| **文件 I/O** | SYS_WRITE (64) | 写入文件描述符 |
|  | SYS_READ (63) | 从文件描述符读取 |
|  | SYS_OPENAT (56) | 打开文件（现代 Linux openat）|
|  | SYS_CLOSE (57) | 关闭文件描述符 |
|  | SYS_GETDENTS64 (61) | 列出目录条目 |
| **系统信息** | SYS_GETMEMINFO (960) | 获取内存信息 |
|  | SYS_GETDEVICES (950) | 获取设备信息 |
| **系统控制** | SYS_ELINOS_VERSION (902) | 获取系统版本 |
|  | SYS_ELINOS_SHUTDOWN (903) | 系统关机 |
|  | SYS_ELINOS_REBOOT (904) | 系统重启 |

### I/O 调用栈

```
用户命令 → 系统调用 → 文件系统 → VirtIO → QEMU
```

## 内存布局

### 物理内存组织

```
0x80000000  ┌─────────────────┐  ← 内核开始
            │ 内核代码段      │  
            │ 内核数据段      │  
0x80200000  ├─────────────────┤  ← 动态检测内核结束
            │ 堆空间          │  (智能分配)
            ├─────────────────┤
            │ 栈空间          │  (页对齐)
            ├─────────────────┤
            │ VirtIO 缓冲区   │  (设备 I/O)
0x81000000  ├─────────────────┤
            │ 用户空间        │  (预留)
0x88000000  └─────────────────┘  ← 内存结束 (128MB)
```

### 内存管理特性

- **动态内核大小检测** - 自动计算内核大小
- **智能堆分配** - 根据可用内存动态调整
- **页对齐操作** - 4KB 页边界对齐
- **安全防护** - 内存区域间隔离保护

## VirtIO 块设备架构

### VirtIO 实现

elinOS 实现了完整的 VirtIO 块设备驱动：

```
应用层     │ 用户命令 (ls, cat)
───────────┼──────────────────────
内核层     │ 系统调用接口
          │ FAT32 文件系统
          │ VirtIO 块设备驱动
          │ MMIO 传输层
───────────┼──────────────────────
硬件层     │ QEMU VirtIO 设备
```

### VirtIO 特性

- **MMIO 传输** - 内存映射 I/O 传输层
- **传统支持** - 兼容 Legacy VirtIO 1.0
- **现代支持** - 支持 VirtIO 1.1+ 协议
- **描述符链** - 高效的 I/O 请求管理
- **中断处理** - 设备状态变化通知

### 队列管理

```rust
// VirtIO 队列结构
struct VirtioQueue {
    desc_table: VirtqDesc,    // 描述符表
    avail_ring: VirtqAvail,   // 可用环
    used_ring: VirtqUsed,     // 已用环
}
```

## FAT32 文件系统

### 文件系统架构

- **引导扇区解析** - 自动检测 FAT32 参数
- **动态根目录** - 从引导扇区计算根目录位置
- **LFN 支持** - 长文件名条目处理
- **集群映射** - 集群到扇区的地址转换

### FAT32 实现特性

```rust
struct Fat32FileSystem {
    boot_sector: Fat32BootSector,
    root_dir_sector: u64,        // 动态计算
    files: Vec<FileEntry, 64>,   // 文件缓存
}
```

## 项目结构

```
src/
├── main.rs              # 内核入口点和启动
├── syscall/             # 系统调用接口
│   ├── mod.rs           # 系统调用分发器
│   ├── file.rs          # 文件 I/O 操作
│   ├── memory.rs        # 内存管理
│   ├── process.rs       # 进程管理
│   └── elinos.rs        # elinOS 特定操作
├── commands.rs          # 用户命令处理
├── memory.rs            # 动态内存管理
├── console.rs           # 控制台抽象
├── uart.rs              # UART 驱动
├── filesystem.rs        # FAT32 文件系统
├── virtio_blk.rs        # VirtIO 块设备驱动
└── sbi.rs              # OpenSBI 接口
```

## 核心组件详解

### VirtIO 块设备驱动

**特性**：
- rust-vmm 风格的实现
- 完整的设备发现和初始化
- Legacy 和 Modern VirtIO 支持
- 内存安全的 I/O 操作

**初始化流程**：
1. 设备发现 (MMIO 扫描)
2. 设备握手 (VirtIO 协议)
3. 特性协商 (设备能力)
4. 队列设置 (I/O 缓冲区)
5. 设备就绪 (开始服务)

### FAT32 文件系统

**核心功能**：
- 引导扇区解析和验证
- 文件分配表 (FAT) 遍历
- 目录条目解析 (8.3 和 LFN)
- 文件内容读取

**目录结构解析**：
```
FAT32 目录条目 (32 字节)
├── 文件名 (8 字节)
├── 扩展名 (3 字节) 
├── 属性 (1 字节)
├── 创建时间 (2 字节)
├── 修改时间 (2 字节)
├── 起始集群 (4 字节)
└── 文件大小 (4 字节)
```

### 系统调用实现

**文件操作流程**：
```
1. SYS_OPENAT → 文件路径解析
2. SYS_READ   → VirtIO 块读取
3. SYS_CLOSE  → 资源释放
```

## 设计原则

### 实验导向
- **清晰的代码结构** - 便于理解和学习
- **丰富的调试信息** - 详细的操作日志
- **现代操作系统概念** - VirtIO、系统调用、文件系统

### 内存安全
- **Rust 类型系统** - 编译时安全保证
- **无裸指针** - 使用安全的内存抽象
- **边界检查** - 防止缓冲区溢出

### 模块化设计
- **松耦合组件** - 清晰的接口边界
- **可扩展架构** - 易于添加新功能
- **测试友好** - 独立的功能模块

## 性能考虑

### I/O 优化
- **批量操作** - 减少系统调用开销
- **缓存机制** - 文件系统元数据缓存
- **异步 I/O** - VirtIO 队列机制

### 内存优化
- **栈分配** - 避免动态内存分配
- **零拷贝** - 直接 DMA 操作
- **页对齐** - 提高内存访问效率

## 开发模式

### 添加新系统调用

1. **选择分类** - 确定适当的数值范围
2. **实现处理器** - 在分类文件中添加函数
3. **更新分发器** - 在中央路由器中添加案例
4. **添加命令** - 在 `commands.rs` 中可选的用户空间命令
5. **文档** - 更新帮助和文档

### 添加新命令

1. **实现函数** - 在 `commands.rs` 中添加 `cmd_name()` 函数
2. **更新分发器** - 在 `process_command()` 中添加匹配案例
3. **更新帮助** - 添加到帮助命令输出
4. **测试** - 命令立即在 shell 中可用

### 内存管理

**安全分配**：
```rust
// 内存安全的堆分配
let memory = memory::allocate_aligned(size, alignment)?;
defer! { memory::deallocate(memory, size); }
```

**栈管理**：
- 每个 hart 的栈防止干扰
- 2MB 大小支持深度调用链
- 自动溢出检测

## 测试和调试

### 内置调试
- 使用 `memory` 命令的内存布局可视化
- 系统调用跟踪能力
- 实时系统信息

### QEMU 集成
- 原生 RISC-V 64 位执行
- GDB 调试支持
- 开发用控制台输出

### 错误处理
- 全面的错误消息
- 优雅的故障模式
- 恢复机制

## 未来架构

### 计划扩展
- **虚拟内存**：RISC-V Sv39 页表
- **进程隔离**：用户/内核模式分离
- **网络栈**：TCP/IP 实现
- **设备驱动**：更多硬件设备支持

### 可扩展性考虑
- **多核支持**：SMP 安全的数据结构
- **性能**：尽可能使用无锁算法
- **模块化**：扩展的插件架构

这个架构为实验性内核提供了坚实的基础，同时保持了简单性和安全性，使 elinOS 成为一个优秀的学习和开发平台。

## 进阶学习

- [快速上手指南](getting-started.md) - 系统安装和基础使用
- [命令参考手册](commands.md) - 学习系统命令
- [开发指南](development.md) - 参与系统开发

## 📖 完整文档

深入的技术细节和代码示例请参考英文完整版：

- [📖 英文完整版](../en/architecture.md) - 包含完整的技术深度解析

---

> **提示**: 深入的技术细节和代码示例请参考英文文档。 