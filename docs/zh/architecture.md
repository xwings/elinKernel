# elinOS 技术架构

> **🚧 翻译进行中** - 本文档正在翻译中，详细内容请参考 [英文完整版](../en/architecture.md)。

本文档提供 elinOS 架构、设计原则和实现细节的详细技术信息。

## 设计理念

elinOS 优先考虑**教育清晰性**而非生产复杂性：

- **嵌入式文件系统**：简单的 ext4 实现，无复杂设备驱动
- **直接硬件访问**：UART 通信，无 VirtIO 开销
- **专注核心概念**：内存管理、系统调用和 ELF 加载
- **Rust 安全性**：类型安全实现，防止常见操作系统错误
- **模块化设计**：关注点清晰分离，便于学习

## 系统调用架构

elinOS 实现了**结构清晰**的操作系统架构，采用受 **Qiling 框架**启发的行业标准组织方式。

### 分类系统调用组织

系统调用按逻辑类别组织，具有专用的数字范围：

| 范围 | 类别 | 用途 | 示例 |
|------|------|------|------|
| 1-50 | 文件 I/O 操作 | 文件操作 | read, write, open, close, unlink |
| 51-70 | 目录操作 | 目录管理 | mkdir, rmdir, chdir, getcwd |
| 71-120 | 内存管理 | 内存操作 | mmap, munmap, mprotect, brk |
| 121-170 | 进程管理 | 进程控制 | exit, fork, execve, wait, kill |
| 171-220 | 设备和 I/O 管理 | 设备控制 | ioctl, fcntl, pipe, dup |
| 221-270 | 网络操作 | 网络协议栈 | socket, bind, listen, accept |
| 271-300 | 时间和定时器操作 | 时间管理 | gettimeofday, nanosleep |
| 301-350 | 系统信息 | 系统查询 | uname, sysinfo, getuid |
| 900-999 | elinOS 特定操作 | 操作系统特有功能 | debug, version, shutdown |

## 内存布局

### 物理内存组织

```
0x80000000  ┌─────────────────┐  ← 内核开始
            │ 内核代码        │  (2MB 保留)
0x80200000  ├─────────────────┤  ← 内核结束
            │ 堆空间          │  (动态大小)
            ├─────────────────┤
            │ Hart 0 栈       │  (2MB)
            ├─────────────────┤
            │ Hart 1 栈       │  (2MB)
            ├─────────────────┤
            │ Hart 2 栈       │  (2MB)
            ├─────────────────┤
            │ Hart 3 栈       │  (2MB)
0x88000000  └─────────────────┘  ← 内存结束 (默认 128MB)
```

## 项目结构

```
src/
├── main.rs              # 内核入口点和命令行
├── syscall/             # 系统调用接口 (内核空间)
│   ├── mod.rs           # 中央分发器和工具
│   ├── file.rs          # 文件 I/O 操作 (1-50)
│   ├── directory.rs     # 目录操作 (51-70)
│   ├── memory.rs        # 内存管理 (71-120)
│   ├── process.rs       # 进程管理 (121-170)
│   ├── device.rs        # 设备和 I/O 管理 (171-220)
│   ├── network.rs       # 网络操作 (221-270)
│   ├── time.rs          # 时间和定时器操作 (271-300)
│   ├── sysinfo.rs       # 系统信息 (301-350)
│   └── elinos.rs        # elinOS 特定操作 (900-999)
├── commands.rs          # 用户空间命令和动态分发
├── memory.rs            # 动态内存管理
├── sbi.rs              # OpenSBI 接口，支持关机
├── filesystem.rs       # 嵌入式 ext4 文件系统实现
├── elf.rs              # ELF 加载器实现
└── linker.ld           # 灵活内存布局的链接器脚本
```

## 核心组件

### 系统调用接口

**专业组织**：
- 9 文件结构，每个类别自包含
- 遵循 Qiling 框架方法论的行业标准
- 基于范围的数字，为未来扩展提供保障
- 结构清晰的设计，6 个类别中实现了 15+ 系统调用

### ELF 加载器

**专业实现**：
- 完整的 ELF64 解析和验证
- 程序头分析和段信息
- 使用 Rust 类型系统的内存安全 ELF 处理
- 通过进程管理类别与系统调用系统集成

## 设计原则

### 清晰架构
- **可扩展组织**：易于在类别内添加新功能
- **可维护结构**：明确的所有权和责任
- **行业标准**：遵循 Qiling 等成熟框架

### 类型安全
- **利用 Rust**：充分利用 Rust 的类型系统
- **编译时保证**：防止整类错误
- **安全抽象**：硬件访问封装在安全接口中

### 嵌入式 ext4 文件系统

**教育性实现**：
- 真实的 ext4 超级块，包含正确的魔术号和元数据
- 内存中的文件系统，无需复杂的块设备驱动
- 专注文件系统概念，便于学习和调试
- 所有数据在内存中，无硬件依赖

**优势**：
- **教育专注**：学习 ext4 结构，无设备复杂性
- **真实数据**：正确的 ext4 超级块和魔术号
- **简单架构**：无 VirtIO、MMIO 或复杂设备协议
- **易于调试**：所有数据在内存中，无硬件依赖

## 📖 完整文档

详细的技术架构、内存管理、设备支持等信息，请参考英文完整版：

- [📖 英文完整版](../en/architecture.md) - 包含完整的技术深度解析

## 🤝 参与翻译

如果您愿意帮助完善此文档的中文翻译：

1. 参考英文版本的详细技术内容
2. 翻译复杂的技术概念和代码示例
3. 保持技术术语的准确性和一致性
4. 提交 Pull Request

---

> **提示**: 深入的技术细节和代码示例请参考英文文档。 